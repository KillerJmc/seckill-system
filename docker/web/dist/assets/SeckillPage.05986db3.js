import{defineComponent as A,ref as s,onMounted as O,computed as b,openBlock as g,createElementBlock as k,toDisplayString as h,unref as D,onBeforeMount as L,reactive as M,createElementVNode as e,createTextVNode as w,createBlock as N,createCommentVNode as F,normalizeClass as R,pushScopeId as P,popScopeId as U}from"https://esm.sh/vue@^3.2.41";import{u as x,b as V,a as G,M as S}from"./settings.88243537.js";import{useRouter as H}from"https://esm.sh/vue-router@^4.1.6";import{_ as K}from"./index.4e7bf9b6.js";import"https://esm.sh/pinia@^2.0.23";import"https://esm.sh/js-cookie@^3.0.1";import"https://esm.sh/axios@^1.1.2";import"https://esm.run/js-sha256@^0.9.0";const z=A({__name:"CountDown",props:{remainTime:{type:Number,default:0}},emits:["count-down-end"],setup(v,{emit:c}){const _=v,o=s(0),a=s(0),t=s(0),r=s(0);O(()=>{if(_.remainTime>0){o.value=Math.floor(_.remainTime/3600),a.value=Math.floor(_.remainTime/60%60),t.value=Math.floor(_.remainTime%60),m();return}c("count-down-end")});const m=()=>{clearInterval(r.value),r.value=setInterval(()=>{o.value===0?a.value!==0&&t.value===0?(t.value=59,a.value-=1):a.value===0&&t.value===0?(t.value=0,c("count-down-end"),clearInterval(r.value)):t.value-=1:a.value!==0&&t.value===0?(t.value=59,a.value-=1):a.value===0&&t.value===0?(o.value-=1,a.value=59,t.value=59):t.value-=1},1e3)},i=f=>f<10?"0"+f:""+f,p=b(()=>i(o.value)),u=b(()=>i(a.value)),y=b(()=>i(t.value));return(f,B)=>(g(),k("span",null,h(D(p)+":"+D(u)+":"+D(y)),1))}}),l=v=>(P("data-v-5fbdd2b5"),v=v(),U(),v),$={class:"header"},j=l(()=>e("div",{class:"left-block"},null,-1)),q=l(()=>e("div",{class:"title"},[e("p",null,"Lingyuangou")],-1)),J=l(()=>e("div",{class:"right-block"},null,-1)),Q={class:"account-bar"},W=l(()=>e("div",{class:"account-info"},null,-1)),X={class:"account-name"},Y={class:"content"},Z={key:0,class:"seckill-form"},ee={class:"information"},te=l(()=>e("br",null,null,-1)),ae=l(()=>e("br",null,null,-1)),oe={class:"time"},ne={class:"button-view"},ue={key:1,class:"seckill-success-form"},se=l(()=>e("div",{class:"order-info-title"},"\u8BA2\u5355\u4FE1\u606F",-1)),le={class:"order-info"},ce=l(()=>e("br",null,null,-1)),re=A({__name:"SeckillPage",setup(v){const c=H(),_=x(),o=V(),a=G();L(async()=>{a.verifyLogin()||(alert(S.NOT_LOGGED_ON),await c.push("/"));let n=await _.getInfo(),d=await o.getCurrent();if((n.code!==200||d.code!==200)&&await c.push("/"),t.value=n.data,r.value=d.data,!t.value.applied){console.warn("\u7528\u6237\u672A\u7533\u8BF7\u6D3B\u52A8\uFF01"),await c.push("/apply");return}u.remainSeconds=(await o.getCountDown()).data,u.display=!0;let E=setInterval(async()=>{if(u.end){let C=await o.getSeckillUrl();C.code===200&&(m.value=C.data,console.log("\u83B7\u53D6\u5230\u79D2\u6740\u94FE\u63A5\uFF1A"+m.value),clearInterval(E))}},1e3)});const t=s({}),r=s({product:{},rule:{}}),m=s(""),i=s(!1),p=s({}),u=M({remainSeconds:0,display:!1,end:!0}),y=b(()=>m.value!==""&&u.end),f=async()=>{if(!y.value){await alert(S.SECKILL_NOT_STARTED);return}let n=await o.seckill(m.value);if(n.code===500&&(alert(n.message),n.message!==S.PURCHASE_REPEAT))return;n.code===200&&await alert(S.SECKILL_SUCCESS);let d=await o.getOrder();if(d.code===500)return;const{putOrderSuccess:E}=d.data;if(!E){await alert(S.PUT_ORDER_FAILED);return}p.value=d.data,i.value=!0},B=async()=>{let n=await o.pay(p.value.orderId);if(n.code===500){await alert(n.message);return}await alert(S.PURCHASE_SUCCESS)},I=()=>{u.end=!0},T=async()=>{await a.logout(),await c.push("/")};return(n,d)=>(g(),k("div",null,[e("div",$,[j,q,J,e("div",Q,[W,e("div",X,h(t.value.name),1),e("div",{class:"log-out",onClick:T},"\u9000\u51FA\u767B\u5F55")])]),e("div",Y,[i.value?F("",!0):(g(),k("div",Z,[e("div",ee,[w(h(r.value.product.name)+" ",1),te,ae,w(" \u5E93\u5B58\u603B\u91CF\uFF1A"+h(r.value.amount)+"\u4EFD ",1)]),e("div",oe,[w(" \u6D3B\u52A8\u5012\u8BA1\u65F6: "),u.display?(g(),N(z,{key:0,"remain-time":u.remainSeconds,onCountDownEnd:I},null,8,["remain-time"])):F("",!0)]),e("div",ne,[e("button",{onClick:f,class:R({"enter-button":!0,disabled:!D(y)})},"\u79D2\u6740",2)])])),i.value?(g(),k("div",ue,[se,e("div",le,[w(" \u8BA2\u5355\u7F16\u53F7\uFF1A"+h(p.value.orderId),1),ce,w(" \u8BA2\u5355\u91D1\u989D\uFF1A"+h(p.value.money)+"\u5143 ",1)]),e("div",{class:"button-view"},[e("button",{onClick:B,class:"enter-button"},"\u4ED8\u6B3E")])])):F("",!0)])]))}});const he=K(re,[["__scopeId","data-v-5fbdd2b5"]]);export{he as default};
